Option Explicit
Dim voyW
Dim zb
Dim zsh
Dim befLdTime
Dim aftLdTime
Dim befDsTime
Dim aftDsTime
Function 获得装卸货前后等待时间()
 'v1.0可以整合航次报表和燃润料报表到一张表里
Application.ScreenUpdating = 0
Application.DisplayAlerts = 0
Dim startRow As Integer
Dim endRow As Integer
Dim r As Integer
Dim voyValue As Integer


Dim addVoy As String
Dim absentVoy As String
Dim shipName As String
Dim shipNameShort As String
Dim shipNum As String
Dim voy As String
Dim thisSameShipVoy As String
Dim lastSameShipVoy As String
Dim voyYear As String
Dim filePath As String
Dim oilDir  As String
Dim oilDir2 As String
Dim voyDir As String
Dim voyDir2 As String
Dim oilName As String
Dim voyName As String


Dim isSameShipVoy
    Set zb = ActiveWorkbook
    Set zsh = ActiveSheet
    startRow = [c6666].End(xlUp).Row + 1
    endRow = [a1].End(xlDown).Row
    startRow = 2
    For r = startRow To endRow Step 1
        If Cells(r, 3) <> "" Then
            GoTo nextr
        End If
        shipName = Cells(r, 1).Value
        shipNameShort = shipName
        shipNum = Right(shipName, 2)
        voy = Cells(r, 2).Value
        voyValue = 提取航次号(voy)
        lastSameShipVoy = Cells(r - 1, 1).Value & Cells(r - 1, 2).Value
        thisSameShipVoy = Cells(r, 1).Value & Cells(r, 2).Value
        isSameShipVoy = lastSameShipVoy = thisSameShipVoy
        
    '
    '    If isWriten Or isSameShipVoy Then '已经填写了
    '        GoTo nextr
    '    End If
        
        If IsNumeric(shipNum) Then
        Else
            shipNum = Right(shipNum, 1)
        End If
        Select Case shipNum
            Case 17
                shipName = "鼎衡17（万年青）"
            Case 18
                shipName = "鼎衡18（常春藤）"
            Case 32
                shipName = "建兴32"
            Case Else
                shipName = "鼎衡" & shipNum
        End Select
        
        voyYear = "\20" & Mid(voy, 2, 2) & "年\"
        filePath = "\\192.168.0.223\航运在线\10、油料管理部\航次报表\" & shipName & voyYear & shipNameShort
        oilDir = filePath & "燃*航次报表*" & voyValue & "*.xls?"
        oilDir2 = filePath & "*料*航次报表*" & voyValue & "*.xls?"
        voyDir = filePath & "航次报表*" & voyValue & "*.xls?"
        voyDir2 = filePath & "*船舶航次报表*" & voyValue & "*.xls?"
        
        If Len(Dir(oilDir)) = 0 Then
            oilDir = oilDir2
        End If
        If Len(Dir(voyDir)) = 0 Then
            voyDir = voyDir2
        End If
        
        If Len(Dir(voyDir)) > 0 Then  '如果文件存在
            oilName = Dir(oilDir)
            voyName = Dir(voyDir)
            'Set oilW = Workbooks.Open(fileName:=oilDir)
            Set voyW = Workbooks.Open(fileName:=voyDir)
            
            'Call TC燃润料报表整合(oilW, r, colDO)
            Call 业务管理航次报表整合(r)
            
            'voyLine = voyW.Sheets(1).[h4].Value & "-" & voyW.Sheets(1).[h5].Value
            'zsh.Cells(r, colDO - 9).Value = voyLine
            
    '        oldOilW = oilW.FullName
    '        newOilW = filePath & "燃润料航次报表" & voy & voyLine & ".xlsx"
    '        oldVoyW = voyW.FullName
    '        newVoyW = filePath & "船舶航次报表" & voy & voyLine & ".xlsx"
    '        If oldOilW <> newOilW Then
    '            oilW.SaveAs newOilW, FileFormat:=xlOpenXMLWorkbook
    '            Kill oldOilW
    '        End If
    '        If oldVoyW <> newVoyW Then
    '            voyW.SaveAs newVoyW, FileFormat:=xlOpenXMLWorkbook
    '            Kill oldVoyW
    '        End If
    '
            'oilW.Close
            voyW.Close
            
            addVoy = addVoy & shipName & voy & vbCrLf
        Else
            absentVoy = absentVoy & shipName & voy & vbCrLf
        End If
nextr:
    'If r = 77 Then
    '    a = 1
'    'End If
'    r = r - 1
    Next r
    If addVoy = "" Then
        MsgBox "没有新增"
    Else
        MsgBox "已加入:" & vbCrLf & addVoy
    End If
    If absentVoy = "" Then
        MsgBox "没有缺的"
    Else
        MsgBox "没有航次报表:" & vbCrLf & absentVoy
    End If
Application.ScreenUpdating = 1
Application.DisplayAlerts = 1
End Function
Function 业务管理航次报表整合(zshRow)
'v1.0 业务管理航次报表整合
 
Dim arLdPort()
Dim arStartLdTime()
Dim arEndLdTime()
Dim arDsPort()
Dim arStartDsTime()
Dim arEndDsTime()
Dim arSkipKey()
Dim arLoadKey()
Dim arDiscKey()
Dim arSep()
Dim arJetty()

Dim ldPort As String
Dim dsPort As String

Dim cargo As String
Dim quantity As String
Dim strLdPort As String
Dim strTempLdLocation As String
Dim strTempDsLocation As String
Dim strDsPort As String
Dim strReason As String
Dim portName As String

Dim berthLdTime As Date
Dim leaveLdTime As Date
Dim berthDsTime As Date
Dim leaveDsTime As Date
Dim startLdTime As Date
Dim endLdTime As Date
Dim startDsTime As Date
Dim endDsTime As Date

Dim dateStartVoy As Date
Dim dateEndVoy As Date

Dim lastVoyDsToThisVoyLd As Double
Dim avgSpeed As Double

Dim colBefLd As Integer
Dim colAftLd As Integer
Dim cofBefDs As Integer
Dim cofAftDs As Integer


Dim countLdSep As Integer
Dim countDsSep As Integer
Dim countLdPort As Integer
Dim countDsPort As Integer

Dim countEpt As Integer

Dim countL As Integer
Dim countD As Integer

Dim i As Integer
Dim iSkip As Integer
Dim iLoad As Integer
Dim iDisc As Integer

Dim d As Integer
Dim l As Integer

Dim instrPlus As Integer

Dim roPort As Integer
Dim roReason As Integer

Dim isbefLdTimeStrange      As Boolean
Dim isaftLdTimeStrange      As Boolean
Dim isbefDsTimeStrange      As Boolean
Dim isaftDsTimeStrange      As Boolean

Dim isTimeStrange      As Boolean


Dim wsh As Worksheet
berthLdTime = 0
berthDsTime = 0

colBefLd = 3
colAftLd = 4
cofBefDs = 5
cofAftDs = 6

countLdSep = 0
countDsSep = 0
countLdPort = 0
countDsPort = 0

countL = 0
countD = 0

i = 0
l = 0
d = 0

strLdPort = ""
strDsPort = ""


    'voyW.Activate
    isTimeStrange = False
    Set wsh = voyW.Sheets("航次报表")
    arSep = Array("&")
    For i = 0 To UBound(arSep)
        Range(Cells(4, 8), Cells(5, 8)).Replace What:=arSep(i), Replacement:="+", LookAt:=xlPart
    Next i
    cargo = [d4].Value
    quantity = [f4].Value
    strLdPort = [h4].Value
    strDsPort = [h5].Value
    dateStartVoy = [b5].Value
    dateEndVoy = [d5].Value
    
    countLdSep = Len(strLdPort) - Len(Replace(strLdPort, "+", "")) 'InStr(1, strLdPort, "+")
    countDsSep = Len(strDsPort) - Len(Replace(strDsPort, "+", "")) 'InStr(1, strDsPort, "+")
    countLdPort = countLdSep + 1
    countDsPort = countDsSep + 1
    
    ReDim arLdPort(countLdSep)
    ReDim arStartLdTime(countLdSep)
ReDim arEndLdTime(countLdSep)

    ReDim arDsPort(countDsSep)
    ReDim arStartDsTime(countDsSep)
    ReDim arEndDsTime(countDsSep)

    If countLdSep > 0 Then
        For l = 0 To countLdSep - 1 Step 1
            instrPlus = InStr(1, strLdPort, "+")
            arLdPort(l) = Mid(strLdPort, 1, instrPlus - 1)
            strLdPort = Right(strLdPort, Len(strLdPort) - instrPlus)
        Next l
    End If
    arLdPort(l) = strLdPort
    
    If countDsSep > 0 Then
        For l = 0 To countDsSep - 1 Step 1
            instrPlus = InStr(1, strDsPort, "+")
            arDsPort(l) = Mid(strDsPort, 1, instrPlus - 1)
            strDsPort = Right(strDsPort, Len(strDsPort) - instrPlus)
        Next l
    End If
    arDsPort(l) = strDsPort
    
    For roPort = 7 To 15 Step 1
        portName = Left(Cells(roPort, 1).Value, 2)
        If portName = "" Then
            Exit For
        End If
        If countL <= UBound(arLdPort) Then
            For l = countL To UBound(arLdPort)
                ldPort = arLdPort(l)
                If portName Like "*" & ldPort & "*" Then
                    If berthLdTime = 0 Then '是第一个靠港
                        lastVoyDsToThisVoyLd = Cells(roPort, 5).Value
                        avgSpeed = Cells(roPort, 6).Value
                    End If
                    berthLdTime = berthLdTime + Cells(roPort, 2).Value
                    leaveLdTime = leaveLdTime + Cells(roPort, 3).Value
                    countL = countL + 1
                    GoTo nextRoPort
                End If
            Next l
        End If
        If countD <= UBound(arDsPort) Then
            For d = countD To UBound(arDsPort)
                dsPort = arDsPort(d)
                If portName Like "*" & dsPort & "*" Then
                    berthDsTime = berthDsTime + Cells(roPort, 2).Value
                    leaveDsTime = leaveDsTime + Cells(roPort, 3).Value
                    countD = countD + 1
                    GoTo nextRoPort
                End If
            Next d
        End If
nextRoPort:
    Next roPort
    

            
    If berthLdTime = 0 Or berthDsTime = 0 Then
        MsgBox "无靠泊时间"
    End If
    
    'arAnchKey = Array("*抛锚*")
    arSkipKey = Array("原因*", "*商检*", "*办手续*")
    arLoadKey = Array("*装货时间*", "*装货作业*", "装货", "装货*", "*续装*")
    arDiscKey = Array("*卸货时间*", "*卸货作业*", "卸货", "卸货*", "*续卸*")

countL = 0
countD = 0
    For roReason = 37 To 66 Step 1
        strReason = Cells(roReason, 5).Value
        'skip
        If strReason = "" Then
            countEpt = countEpt + 1
            If countEpt > 5 Then
                Exit For
            End If
            GoTo nextRoReason
        Else
            countEpt = 0
        End If
        
        For iSkip = 0 To UBound(arSkipKey) Step 1
            If strReason Like arSkipKey(iSkip) Then
                GoTo nextRoReason
            End If
        Next iSkip
        'anchor
'        For iAnchor = 0 To UBound(arAnchKey)
'            If strReason Like arAnchKey(iAnchor) Then
'                'arrivedTime = Cells(roReason, 2).Value
'                GoTo nextRoReason
'            End If
'        Next iAnchor
        'load
        'If countL <= countLdSep Then
            For iLoad = 0 To UBound(arLoadKey)
                If strReason Like arLoadKey(iLoad) Then
                    strLocation = Cells(roReason, 1).Value
                    tempEndLdTime = Cells(roReason, 3).Value
                    'test/////////////////////////////////////////////
                    If strTempLdLocation <> strLocation Then
                        strTempLdLocation = strLocation
                        startLdTime = startLdTime + Cells(roReason, 2).Value
                        endLdTime = endLdTime + Cells(roReason, 3).Value
                    ElseIf strTempLdLocation = strLocation Then
                        endLdTime = endLdTime - tempEndLdTime
                    End If
                    '/test/////////////////////////////////////////////
                            '/////////////////////////////////////////////
                    countL = countL + 1
                    GoTo nextRoReason
                End If
            Next iLoad
        'End If
        'disc
        'If countD <= countDsSep Then
            For iDisc = 0 To UBound(arLoadKey)
                If strReason Like arDiscKey(iDisc) Then
                    startDsTime = startDsTime + Cells(roReason, 2).Value
                    endDsTime = endDsTime + Cells(roReason, 3).Value
                    countD = countD + 1
                    GoTo nextRoReason
                End If
            Next iDisc
        'End If
nextRoReason:
'        If countL + countD = countLdPort + countDsPort Then
'            Exit For
'        End If
        
    Next roReason
    
        If startLdTime = 0 Then
            MsgBox "无装货时间"
        End If
        If startDsTime = 0 Then
            MsgBox "无卸货时间"
        End If
    roReason = 0
'    befLdTime = startLdTime - berthLdTime
'    aftLdTime = leaveLdTime - endLdTime
'    befDsTime = startDsTime - berthDsTime
'    aftDsTime = leaveDsTime - endDsTime
    befLdTime = (startLdTime - berthLdTime) / countLdPort
    aftLdTime = (leaveLdTime - endLdTime) / countLdPort
    befDsTime = (startDsTime - berthDsTime) / countDsPort
    aftDsTime = (leaveDsTime - endDsTime) / countDsPort

    
'        berthLdTime = berthLdTime / countLdPort
'        leaveLdTime = leaveLdTime / countLdPort
'        berthDsTime = berthDsTime / countDsPort
'        leaveDsTime = leaveDsTime / countDsPort
'
    
    isbefLdTimeStrange = Abs(befLdTime) > 1.5
    isaftLdTimeStrange = Abs(aftLdTime) > 1.5
    isbefDsTimeStrange = Abs(befDsTime) > 1.5
    isaftDsTimeStrange = Abs(aftDsTime) > 1.5

    isTimeStrange = isbefLdTimeStrange Or isaftLdTimeStrange Or isbefDsTimeStrange Or isaftDsTimeStrange
          
    zsh.Cells(zshRow, 3).Value = befLdTime * 24
    zsh.Cells(zshRow, 4).Value = aftLdTime * 24
    zsh.Cells(zshRow, 5).Value = befDsTime * 24
    zsh.Cells(zshRow, 6).Value = aftDsTime * 24
    'zsh.Activate
    If isTimeStrange Then
        zsh.Activate
        MsgBox "过大"
    End If
    berthLdTime = 0
    leaveLdTime = 0
    startDsTime = 0
    endDsTime = 0
    
End Function
Function 船名分组()
Application.ScreenUpdating = 0
Application.DisplayAlerts = 0
    arShip = Array("鼎衡15", "鼎衡16", "建兴32", "鼎衡", "鼎衡1", "鼎衡17", "鼎衡3", "鼎衡", "鼎衡2", "鼎衡5", "鼎衡9", "鼎衡10", "鼎衡18")
    arshipName = Array("DH1", "DH2", "DH3", "DH5", "DH9", "DH10", "DH15", "DH16", "DH17", "DH18", "DH7", "JX32", "DHA", "DHE", "AG1", "AG2", "AG3", "AG11")
    arGp1 = Array("DH15", "DH16", "JX32")
    arGp2 = Array("DH17", "DH1", "DH3")
    arGp3 = Array("DH10", "DH18", "DH2", "DH5", "DH9")
    
    For ro = 2 To [b2].End(xlDown).Row
        lastShip = Cells(ro - 1, 2).Value
        shipName = Cells(ro, 2).Value
        If lastShip = shipName Then
            Cells(ro, 1).Value = Cells(ro - 1, 1).Value
            GoTo nextRO
        End If
        For i = 0 To UBound(arGp1)
            If shipName = arGp1(i) Then
                Cells(ro, 1).Value = 1
                GoTo nextRO
            End If
        Next i
        For j = 0 To UBound(arGp2)
            If shipName = arGp2(j) Then
                Cells(ro, 1).Value = 2
                GoTo nextRO
            End If
        Next j
        For k = 0 To UBound(arGp3)
            If shipName = arGp3(k) Then
                Cells(ro, 1).Value = 3
                GoTo nextRO
            End If
        Next k
nextRO:
    Next ro
Application.ScreenUpdating = 1
Application.DisplayAlerts = 1
End Function
Function 增加航次号()
Application.ScreenUpdating = 0
Application.DisplayAlerts = 0
For i = 2 To 1000
    ro = i
    If Cells(ro, 1) <> Cells(ro + 1, 1) Then
        startRow = ro
        shipName = Cells(ro, 1)
        voyVal = CInt(Right(Cells(ro, 2), 4))
        For v = voyVal To 1760
            Rows(ro + 1).Insert
            Cells(ro + 1, 1) = shipName
            Cells(ro + 1, 2) = "V" & v
            ro = ro + 1
        Next v
    i = ro
    End If
Next i
Application.ScreenUpdating = 1
Application.DisplayAlerts = 1
End Function

