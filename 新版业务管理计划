Option Explicit
Dim zb As Workbook
Dim zsh As Worksheet
Dim wsh As Worksheet
Dim arLdPort(0 To 2, 0 To 8) '装货港三个，0-2
Dim arDsPort(0 To 2, 0 To 8) '卸货港三个，0-2
'将有关港口的信息做到一个数组里
'0装货码头名字
'1抵达装货码头时间
'2靠泊装货码头时间
'3离泊装货码头时间
'4待泊时间
'5开始装货时间
'6结束装货时间
'7装货时间
'8装货速率（吨/小时）

Function 新版业务管理航次报表整合()
 'v1.0可以整合航次报表和燃润料报表到一张表里
Application.ScreenUpdating = 0
Application.DisplayAlerts = 0

Dim startRow As Integer
Dim endRow As Integer
Dim r As Integer
Dim voyValue As Integer

Dim shipName As String
Dim shipNameShort As String
Dim voy As String
Dim lastSameShipVoy As String
Dim thisSameShipVoy As String
Dim voyYear As String
Dim filePath As String
Dim voyDir As String
Dim voyLine As String
Dim addVoy As String
Dim absentVoy As String

Dim isSameShipVoy As Boolean

Dim voyW As Workbook


Set zb = ActiveWorkbook
Set zsh = ActiveSheet
startRow = [c6666].End(xlUp).Row + 1
endRow = [a1].End(xlDown).Row
startRow = 2
For r = startRow To endRow Step 1
    If Cells(r, 3) <> "" Then
        GoTo nextr
    End If
    shipName = Cells(r, 1).Value
    shipNameShort = shipName
    shipName = 船名缩写转全称(shipName)
    voy = Cells(r, 2).Value
    voyValue = 提取航次号(voy)
    lastSameShipVoy = Cells(r - 1, 1).Value & Cells(r - 1, 2).Value
    thisSameShipVoy = Cells(r, 1).Value & Cells(r, 2).Value
    isSameShipVoy = lastSameShipVoy = thisSameShipVoy
    
    voyYear = "\20" & Left(voyValue, 2) & "年\"
    filePath = "\\192.168.0.223\航运在线\10、油料管理部\航次报表\" & shipName & voyYear
    
    'oilDir = 获得燃润料航次报表dir(filePath, shipNameShort, voyValue)
    voyDir = 获得船舶航次报表dir(filePath, shipNameShort, voyValue)
    
    If Len(Dir(voyDir)) > 0 Then  '如果文件存在
        'oilNam = Dir(oilDir)
        'voyName = Dir(voyDir)
        'Set oilW = Workbooks.Open(fileName:=oilDir)
        Set voyW = Workbooks.Open(fileName:=voyDir)
        Set wsh = voyW.Sheets(1)
        'Call TC燃润料报表整合(oilW, r, colDO)
        Call 业务管理获得靠离泊时间(r)
        
        
        'voyLine = voyW.Sheets(1).[h4].Value & "-" & voyW.Sheets(1).[h5].Value
        'zsh.Cells(r, colDO - 9).Value = voyLine
        
'        oldOilW = oilW.FullName
'        newOilW = filePath & "燃润料航次报表" & voy & voyLine & ".xlsx"
        Call 航次报表更名保存(shipNameShort, voy, voyLine)
        
        addVoy = addVoy & shipName & voy & vbCrLf
    Else
        absentVoy = absentVoy & shipName & voy & vbCrLf
    End If
nextr:
'If r = 77 Then
'    a = 1
'End If
Next r
If addVoy = "" Then
    MsgBox "没有新增"
Else
    MsgBox "已加入:" & vbCrLf & addVoy
End If
If absentVoy = "" Then
    MsgBox "没有缺的"
Else
    MsgBox "没有航次报表:" & vbCrLf & absentVoy
End If
Application.ScreenUpdating = 1
Application.DisplayAlerts = 1
End Function
Function 业务管理获得靠离泊时间(zshRow As Integer)

'v0.1 业务管理获得靠离泊时间
 
Dim arAnchKey() '锚泊关键词
Dim arSkipKey() '跳过的关键词
Dim arLoadKey() '装货关键词
Dim arDiscKey() '卸货关键词





Dim colBefLd As Integer
Dim colAftLd As Integer
Dim cofBefDs As Integer
Dim cofAftDs As Integer

Dim countLdSep As Integer
Dim countDsSep As Integer
Dim countLdPort As Integer
Dim countDsPort As Integer
Dim countL As Integer
Dim countD As Integer

Dim i As Integer
Dim iSkip As Integer
Dim iAnchor As Integer
Dim iLoad As Integer
Dim iDisc As Integer

Dim d As Integer
Dim l As Integer
Dim roPort As Integer
Set wsh = localVoyW.Sheets(1)

Dim berthLdTime As Date
Dim isbefLdTimeStrange      As Boolean
Dim isaftLdTimeStrange      As Boolean
Dim isbefDsTimeStrange      As Boolean
Dim isaftDsTimeStrange      As Boolean

Dim isTimeStrange      As Boolean

Dim strTempLdLocation As String
Dim strTempDsLocation As String
Dim strReason As String
Dim strLocation As String

Dim dateStartVoy As Date
Dim dateEndVoy As Date

'
'berthLdTime = 0
'berthDsTime = 0

colBefLd = 3
colAftLd = 4
cofBefDs = 5
cofAftDs = 6

countLdSep = 0
countDsSep = 0
countLdPort = 0
countDsPort = 0

countL = 0
countD = 0

i = 0
l = 0
d = 0

'Dim arLdPort(0 To 2, 0 To 8) '装货港三个，0-2
'Dim arDsPort(0 To 2, 0 To 8) '卸货港三个，0-2
''将有关港口的信息做到一个数组里
''0装货码头名字
''1抵达装货码头时间
''2靠泊装货码头时间
''3离泊装货码头时间
''4待泊时间
''5开始装货时间
''6结束装货时间
''7装货时间
''8装货速率（吨/小时）

    'voyW.Activate
    isTimeStrange = False
    
    Call 获取航次报表表头信息(zshRow)
    
    Call 获取航次报表上半部分信息(zshRow)
    
    Call 获取航次报表下半部分信息(zshRow)
    
    
        If startLdTime = 0 Then
            MsgBox "无装货时间"
        End If
        If startDsTime = 0 Then
            MsgBox "无卸货时间"
        End If
    roReason = 0
'    befLdTime = startLdTime - berthLdTime
'    aftLdTime = leaveLdTime - endLdTime
'    befDsTime = startDsTime - berthDsTime
'    aftDsTime = leaveDsTime - endDsTime
    befLdTime = (startLdTime - berthLdTime) / countLdPort
    aftLdTime = (leaveLdTime - endLdTime) / countLdPort
    befDsTime = (startDsTime - berthDsTime) / countDsPort
    aftDsTime = (leaveDsTime - endDsTime) / countDsPort

    
'        berthLdTime = berthLdTime / countLdPort
'        leaveLdTime = leaveLdTime / countLdPort
'        berthDsTime = berthDsTime / countDsPort
'        leaveDsTime = leaveDsTime / countDsPort
'
    
    isbefLdTimeStrange = Abs(befLdTime) > 1.5
    isaftLdTimeStrange = Abs(aftLdTime) > 1.5
    isbefDsTimeStrange = Abs(befDsTime) > 1.5
    isaftDsTimeStrange = Abs(aftDsTime) > 1.5

    isTimeStrange = isbefLdTimeStrange Or isaftLdTimeStrange Or isbefDsTimeStrange Or isaftDsTimeStrange
          
'    zsh.Cells(zshRow, 3).Value = befLdTime * 24
'    zsh.Cells(zshRow, 4).Value = aftLdTime * 24
'    zsh.Cells(zshRow, 5).Value = befDsTime * 24
'    zsh.Cells(zshRow, 6).Value = aftDsTime * 24

zsh.Cells(zshRow, 3).Value = strVoyLine '航线
zsh.Cells(zshRow, 4).Value = cargo '货名
zsh.Cells(zshRow, 5).Value = quantity '货量
zsh.Cells(zshRow, 6).Value = dateStartVoy '航次开始时间
zsh.Cells(zshRow, 7).Value = dateEndVoy '航次结束时间
zsh.Cells(zshRow, 8).Value = lastVoyDsToThisVoyLd '装卸港距离
zsh.Cells(zshRow, 9).Value = avgSpeed '平均航速
zsh.Cells(zshRow, 10).FormulaR1C1 = "=RC[-2]/RC[-1]" '理论可用洗舱时间
zsh.Cells(zshRow, 11).Value = actualWashingTime '洗舱消耗时间



    'zsh.Activate
    If isTimeStrange Then
        zsh.Activate
        MsgBox "过大"
    End If
    berthLdTime = 0
    leaveLdTime = 0
    startDsTime = 0
    endDsTime = 0
    
End Function
Function 获取航次报表表头信息(zshRow)
Dim cargo As String
Dim quantity As String
Dim strDsPort As String
Dim strLdPort As String
Dim strVoyLine As String

Dim arSepaKey() '分隔符关键词

Dim i As Integer

strLdPort = ""
strDsPort = ""
    arSepaKey = Array("&")
    '替换掉除+以外的分隔符
    
    For i = 0 To UBound(arSepaKey)
        Range(Cells(4, 8), Cells(5, 8)).Replace What:=arSepaKey(i), Replacement:="+", LookAt:=xlPart
    Next i
    
    cargo = [d4].Value '货物名称STR
    quantity = [f4].Value '货量数值INT
    strLdPort = [h4].Value '装货港str
    strDsPort = [h5].Value '卸货港名
    strVoyLine = strLdPort & strDsPort '航线
    dateStartVoy = [b5].Value '航次开始时间
    dateEndVoy = [d5].Value '航次结束时间
'
    countLdSep = Len(strLdPort) - Len(Replace(strLdPort, "+", "")) 'InStr(1, strLdPort, "+")
    countDsSep = Len(strDsPort) - Len(Replace(strDsPort, "+", "")) 'InStr(1, strDsPort, "+")
    countLdPort = countLdSep + 1 '几个装货港
    countDsPort = countDsSep + 1 '几个卸货港
'
    Call 获取装货港名字(countLdSep, strLdPort)
    Call 获取卸货港名字(countDsSep, strDsPort)

End Function
Function 获取装货港名字(lcLdSep As Integer, lcstrLdPort As String)
'lcLdSep 装货港的分隔符号的个数
Dim l As Integer
Dim instrPlus As Integer
l = 0
    If lcLdSep > 0 Then
        For l = 0 To lcLdSep Step 1
            instrPlus = InStr(1, lcstrLdPort, "+")
            arLdPort(l, 0) = Mid(strLdPort, 1, instrPlus - 1)
            lcstrLdPort = Right(lcstrLdPort, Len(lcstrLdPort) - instrPlus)
        Next l
    Else
        arLdPort(l, 0) = lcstrLdPort
    End If
End Function
Function 获取卸货港名字(lcDsSep As Integer, lcstrDsPort As String)
'lcDsSep 卸货港的分隔符号的个数
Dim d As Integer
Dim instrPlus As Integer
d = 0
    If lcDsSep > 0 Then
        For d = 0 To lcDsSep Step 1
            instrPlus = InStr(1, lcstrDsPort, "+")
            arDsPort(d, 0) = Mid(lcstrDsPort, 1, instrPlus - 1)
            lcstrDsPort = Right(lcstrDsPort, Len(lcstrDsPort) - instrPlus)
        Next d
    Else
        arDsPort(d) = lcstrDsPort
    End If
End Function
Function test获取航次报表上半部分信息()
'test
Dim l As Integer
Dim d As Integer
Set zsh = ActiveSheet
arLdPort(l, 0) = "泉州"
arDsPort(d, 0) = "东莞"
'/test
获取航次报表上半部分信息 (2)
End Function
Function 获取航次报表上半部分信息(zshRow As Integer)
Dim roPort As Integer

Dim portName As String
Dim ldPort As String
Dim dsPort As String

Dim countL As Integer
Dim countD As Integer
Dim i As Integer
Dim l As Integer
Dim d As Integer


Dim arrivedTime As Date
Dim berthLdTime As Date
Dim leaveLdTime As Date
Dim berthDsTime As Date
Dim leaveDsTime As Date
Dim startLdTime As Date
Dim endLdTime As Date
Dim startDsTime As Date
Dim endDsTime As Date
Dim tempEndLdTime As Date

Dim lastVoyDsToThisVoyLd As Double
Dim avgSpeed As Double
Dim actualWashingTime As Double
countL = 0
countD = 0

i = 0
l = 0
d = 0
    For roPort = 7 To 25 Step 1
        portName = Left(Cells(roPort, 1).Value, 2)
        If portName = "" Then
            GoTo nextRoPort
        End If
        If countL <= UBound(arLdPort) Then
            For l = countL To UBound(arLdPort)
                ldPort = arLdPort(l, 0)
                If ldPort = "" Then
                    Exit For
                End If
                If portName Like "*" & ldPort & "*" Then
                    If berthLdTime = 0 Then '是第一个靠港
                        lastVoyDsToThisVoyLd = Cells(roPort, 7).Value '装卸港距离
                        avgSpeed = Cells(roPort, 8).Value '平均航速
                        
                        zsh.Cells(zshRow, 8).Value = lastVoyDsToThisVoyLd
                        zsh.Cells(zshRow, 9).Value = avgSpeed
                        zsh.Cells(zshRow, 10).FormulaR1C1 = "=RC[-2]/RC[-1]"
                    End If
                    berthLdTime = Cells(roPort, 2).Value
                    leaveLdTime = Cells(roPort, 3).Value
                    arLdPort(countL, 2) = berthLdTime
                    arLdPort(countL, 3) = leaveLdTime
                    countL = countL + 1
                    GoTo nextRoPort
                End If
            Next l
        End If
        If countD <= UBound(arDsPort) Then
            For d = countD To UBound(arDsPort)
                dsPort = arDsPort(d, 0)
                If dsPort = "" Then
                    Exit For
                End If
                If portName Like "*" & dsPort & "*" Then
                    berthDsTime = Cells(roPort, 2).Value
                    leaveDsTime = Cells(roPort, 3).Value
                    arDsPort(countD, 2) = berthDsTime
                    arDsPort(countD, 3) = leaveDsTime
                    countD = countD + 1
                    GoTo nextRoPort
                End If
            Next d
        End If
        If portName = "洗舱" Then
            actualWashingTime = Cells(roPort, 5).Value '洗舱消耗时间
            Exit For
        End If
nextRoPort:
    Next roPort
    
End Function
Function 获取航次报表下半部分信息(zshRow)
    

            
    If arLdPort(0, 2) = 0 Or arDsPort(0, 2) = 0 Then 'If arLdPort(0,2) = 0 Or berthDsTime = 0 Then
        MsgBox "无靠泊时间"
    End If
    
    arAnchKey = Array("*抛锚*")
    arSkipKey = Array("原因*", "*商检*", "*办手续*")
    arLoadKey = Array("*装货时间*", "*装货作业*", "装货", "装货*", "*续装*")
    arDiscKey = Array("*卸货时间*", "*卸货作业*", "卸货", "卸货*", "*续卸*")

countL = 0
countD = 0
    For roReason = 37 To 66 Step 1
        strReason = Cells(roReason, 5).Value
        'skip
        If strReason = "" Then
            countEpt = countEpt + 1
            If countEpt > 5 Then
                Exit For
            End If
            GoTo nextRoReason
        Else
            countEpt = 0
        End If
        
        For iSkip = 0 To UBound(arSkipKey) Step 1
            If strReason Like arSkipKey(iSkip) Then
                GoTo nextRoReason
            End If
        Next iSkip
        'anchor
        For iAnchor = 0 To UBound(arAnchKey)
            If strReason Like arAnchKey(iAnchor) Then
                arrivedTime = Cells(roReason, 2).Value
                gotoBthTime = Cells(roReason, 3).Value
                GoTo nextRoReason
            End If
        Next iAnchor
        'load
        'If countL <= countLdSep Then
            For iLoad = 0 To UBound(arLoadKey)
                If strReason Like arLoadKey(iLoad) Then
                    strLocation = Cells(roReason, 1).Value
                    tempEndLdTime = Cells(roReason, 3).Value
                    'test/////////////////////////////////////////////
                    If strTempLdLocation <> strLocation Then
                        strTempLdLocation = strLocation
                        startLdTime = startLdTime + Cells(roReason, 2).Value
                        endLdTime = endLdTime + Cells(roReason, 3).Value
                    ElseIf strTempLdLocation = strLocation Then
                        endLdTime = endLdTime - tempEndLdTime
                    End If
                    '/test/////////////////////////////////////////////
                            '/////////////////////////////////////////////
                    countL = countL + 1
                    GoTo nextRoReason
                End If
            Next iLoad
        'End If
        'disc
        'If countD <= countDsSep Then
            For iDisc = 0 To UBound(arLoadKey)
                If strReason Like arDiscKey(iDisc) Then
                    startDsTime = startDsTime + Cells(roReason, 2).Value
                    endDsTime = endDsTime + Cells(roReason, 3).Value
                    countD = countD + 1
                    GoTo nextRoReason
                End If
            Next iDisc
        'End If
nextRoReason:
'        If countL + countD = countLdPort + countDsPort Then
'            Exit For
'        End If
        
    Next roReason
    
End Function
Function 航次报表更名保存(fcshipNameShort As String, fcvoy As String, fcvoyLine As String)

Dim oldVoyW As String
Dim newVoyW As String
Dim fcfilePath As String


    oldVoyW = voyW.FullName
    fcfilePath = voyW.Path & "\"
    newVoyW = fcfilePath & fcshipNameShort & "船舶航次报表" & fcvoy & fcvoyLine & ".xlsx"
    
    If oldVoyW <> newVoyW Then
        voyW.SaveAs newVoyW, FileFormat:=xlOpenXMLWorkbook
        Kill oldVoyW
    End If
'
    'oilW.Close
    voyW.Close
End Function
Function 船名分组()
Application.ScreenUpdating = 0
Application.DisplayAlerts = 0
    arShip = Array("鼎衡15", "鼎衡16", "建兴32", "鼎衡", "鼎衡1", "鼎衡17", "鼎衡3", "鼎衡", "鼎衡2", "鼎衡5", "鼎衡9", "鼎衡10", "鼎衡18")
    arshipName = Array("DH1", "DH2", "DH3", "DH5", "DH9", "DH10", "DH15", "DH16", "DH17", "DH18", "DH7", "JX32", "DHA", "DHE", "AG1", "AG2", "AG3", "AG11")
    arGp1 = Array("DH15", "DH16", "JX32")
    arGp2 = Array("DH17", "DH1", "DH3")
    arGp3 = Array("DH10", "DH18", "DH2", "DH5", "DH9")
    
    For ro = 2 To [b2].End(xlDown).Row
        lastShip = Cells(ro - 1, 2).Value
        shipName = Cells(ro, 2).Value
        If lastShip = shipName Then
            Cells(ro, 1).Value = Cells(ro - 1, 1).Value
            GoTo nextRO
        End If
        For i = 0 To UBound(arGp1)
            If shipName = arGp1(i) Then
                Cells(ro, 1).Value = 1
                GoTo nextRO
            End If
        Next i
        For j = 0 To UBound(arGp2)
            If shipName = arGp2(j) Then
                Cells(ro, 1).Value = 2
                GoTo nextRO
            End If
        Next j
        For k = 0 To UBound(arGp3)
            If shipName = arGp3(k) Then
                Cells(ro, 1).Value = 3
                GoTo nextRO
            End If
        Next k
nextRO:
    Next ro
Application.ScreenUpdating = 1
Application.DisplayAlerts = 1
End Function
Function 增加航次号()
Application.ScreenUpdating = 0
Application.DisplayAlerts = 0
For i = 2 To 1000
    ro = i
    If Cells(ro, 1) <> Cells(ro + 1, 1) Then
        startRow = ro
        shipName = Cells(ro, 1)
        voyVal = CInt(Right(Cells(ro, 2), 4))
        For v = voyVal To 1760
            Rows(ro + 1).Insert
            Cells(ro + 1, 1) = shipName
            Cells(ro + 1, 2) = "V" & v
            ro = ro + 1
        Next v
    i = ro
    End If
Next i
Application.ScreenUpdating = 1
Application.DisplayAlerts = 1
End Function

